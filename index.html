<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trailix</title>
  <link rel="icon" type="png" href="image.png">
  <style>
    /* ===== DESIGN MINIMALISTE TRAILIX ===== */
:root {
  --bg: #0a0a0a;
  --surface: #111111;
  --text: #ffffff;
  --text-dim: #888888;
  --accent: #ff6b6b;
  --border: #222222;
  --radius: 12px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.container {
  width: 100%;
  max-width: 500px;
  background: var(--surface);
  border-radius: var(--radius);
  padding: 40px;
  border: 1px solid var(--border);
}

/* ===== HEADER ===== */
h1 {
  font-size: 2rem;
  font-weight: 700;
  text-align: center;
  margin-bottom: 8px;
  letter-spacing: -0.5px;
}

.subtitle {
  text-align: center;
  color: var(--text-dim);
  font-size: 0.9rem;
  margin-bottom: 40px;
}

/* ===== NAVIGATION ===== */
.switch {
  display: flex;
  background: var(--bg);
  border-radius: 8px;
  padding: 4px;
  margin-bottom: 40px;
}

.switch button {
  flex: 1;
  padding: 12px 20px;
  border: none;
  background: transparent;
  color: var(--text-dim);
  border-radius: 6px;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.switch button.active {
  background: var(--accent);
  color: white;
}

/* ===== SECTIONS ===== */
section {
  display: none;
}

section.active {
  display: block;
}

h2 {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 24px;
  color: var(--text);
}

/* ===== FORMULAIRES ===== */
.form-group {
  margin-bottom: 20px;
}

input, textarea {
  width: 100%;
  padding: 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 0.95rem;
  transition: border-color 0.2s ease;
}

input:focus, textarea:focus {
  outline: none;
  border-color: var(--accent);
}

textarea {
  resize: vertical;
  min-height: 80px;
  font-family: inherit;
}

.file-upload {
  position: relative;
}

.file-input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

.file-label {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background: var(--bg);
  border: 2px dashed var(--border);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: var(--text-dim);
  font-size: 0.9rem;
}

.file-label:hover {
  border-color: var(--accent);
  color: var(--accent);
}

button[type="submit"] {
  width: 100%;
  padding: 16px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-top: 8px;
}

button[type="submit"]:hover:not(:disabled) {
  background: #ff5252;
  transform: translateY(-1px);
}

button[type="submit"]:disabled {
  background: #333;
  cursor: not-allowed;
  transform: none;
}

/* ===== RECHERCHE ===== */
#search {
  margin-bottom: 24px;
}

/* ===== VIDÉOS ===== */
#videos {
  display: grid;
  gap: 24px;
}

.video-card {
  background: var(--bg);
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--border);
}

.video-card video {
  width: 100%;
  display: block;
}

.video-card-content {
  padding: 16px;
}

.video-card h3 {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 8px;
  line-height: 1.3;
}

.video-card p {
  color: var(--text-dim);
  font-size: 0.85rem;
  line-height: 1.4;
  margin-bottom: 12px;
}

/* ===== ACTIONS VIDÉO ===== */
.video-actions {
  display: flex;
  gap: 16px;
  margin-bottom: 12px;
  padding-top: 8px;
  border-top: 1px solid var(--border);
}

.action-btn {
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 0.85rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.action-btn:hover {
  color: var(--text);
  background: var(--surface);
}

.action-btn.liked {
  color: var(--accent);
}

/* ===== COMMENTAIRES ===== */
.comments-section {
  margin-top: 12px;
}

.comment-form {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.comment-input {
  flex: 1;
  padding: 8px 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  color: var(--text);
  font-size: 0.85rem;
  resize: none;
  height: 36px;
}

.comment-input:focus {
  outline: none;
  border-color: var(--accent);
}

.comment-submit {
  padding: 8px 16px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 16px;
  font-size: 0.8rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.comment-submit:hover:not(:disabled) {
  background: #ff5252;
}

.comment-submit:disabled {
  background: #333;
  cursor: not-allowed;
}

.comments-list {
  display: grid;
  gap: 8px;
  max-height: 200px;
  overflow-y: auto;
}

.comment {
  background: var(--surface);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 0.8rem;
}

.comment-text {
  color: var(--text);
  line-height: 1.3;
}

.comment-date {
  color: var(--text-dim);
  font-size: 0.7rem;
  margin-top: 4px;
}

.comments-toggle {
  color: var(--text-dim);
  font-size: 0.8rem;
  cursor: pointer;
  padding: 4px 0;
}

.comments-toggle:hover {
  color: var(--text);
}

/* ===== RESPONSIVE ===== */
@media (max-width: 600px) {
  .container {
    padding: 24px;
    margin: 10px;
  }
  
  h1 {
    font-size: 1.5rem;
  }
}

/* ===== ÉTATS ===== */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-dim);
}

.loading-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top: 2px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 8px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Trailix</h1>
      <p class="subtitle">Créez et partagez</p>
    </header>

    <nav class="switch">
      <button id="show-creator">Créer</button>
      <button id="show-viewer" class="active">Explorer</button>
    </nav>

    <!-- Section Creator -->
    <section id="creator-section">
      <h2>Nouvelle création</h2>
      <form id="upload-form">
        <div class="form-group">
          <input type="text" id="title" placeholder="Titre" required maxlength="100" />
        </div>
        
        <div class="form-group">
          <textarea id="description" placeholder="Description..." required maxlength="300"></textarea>
        </div>
        
        <div class="form-group file-upload">
          <input type="file" id="video" accept="video/*" required class="file-input" />
          <label for="video" class="file-label">
            <span class="file-text">Choisir une vidéo</span>
          </label>
        </div>
        
        <button type="submit">
          <span class="btn-text">Publier</span>
        </button>
      </form>
    </section>

    <!-- Section Viewer -->
    <section id="viewer-section" class="active">
      <h2>Découvrir</h2>
      <input type="text" id="search" placeholder="Rechercher..." />
      <div id="videos"></div>
      <div id="empty-state" class="empty-state" style="display: none;">
        <p>Aucune vidéo trouvée</p>
      </div>
    </section>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
// Configuration Supabase
const SUPABASE_URL = "https://uthmxqncqjrdkmuvqqnk.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0aG14cW5jcWpyZGttdXZxcW5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MDEwMTEsImV4cCI6MjA3Mzk3NzAxMX0.gQtwXtyqSnoXOsJP991tM7E8uajW8MLwaOA6SF6OjGI";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Éléments DOM
const creatorSection = document.getElementById("creator-section");
const viewerSection = document.getElementById("viewer-section");
const creatorBtn = document.getElementById("show-creator");
const viewerBtn = document.getElementById("show-viewer");
const uploadForm = document.getElementById("upload-form");
const fileInput = document.getElementById("video");
const fileLabel = document.querySelector(".file-text");

// Navigation
creatorBtn.addEventListener("click", () => {
  creatorSection.classList.add("active");
  viewerSection.classList.remove("active");
  creatorBtn.classList.add("active");
  viewerBtn.classList.remove("active");
});

viewerBtn.addEventListener("click", () => {
  viewerSection.classList.add("active");
  creatorSection.classList.remove("active");
  viewerBtn.classList.add("active");
  creatorBtn.classList.remove("active");
});

// Upload de fichier
fileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) {
    fileLabel.textContent = file.name;
  } else {
    fileLabel.textContent = "Choisir une vidéo";
  }
});

// Soumission du formulaire
uploadForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const title = document.getElementById("title").value.trim();
  const description = document.getElementById("description").value.trim();
  const file = document.getElementById("video").files[0];

  if (!file || !title || !description) {
    alert("Veuillez remplir tous les champs");
    return;
  }

  const submitBtn = e.target.querySelector('button[type="submit"]');
  const btnText = submitBtn.querySelector('.btn-text');
  
  submitBtn.disabled = true;
  btnText.innerHTML = '<span class="loading-spinner"></span>Upload...';

  try {
    // Upload fichier
    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
    const { data, error } = await supabaseClient.storage
      .from("videos")
      .upload(fileName, file);

    if (error) throw error;

    // URL publique
    const { data: urlData } = supabaseClient.storage
      .from("videos")
      .getPublicUrl(data.path);

    // Sauvegarder en base
    const { error: dbError } = await supabaseClient
      .from("shorts")
      .insert([{ 
        title, 
        description, 
        url: urlData.publicUrl 
      }]);

    if (dbError) throw dbError;

    alert("Vidéo publiée !");
    uploadForm.reset();
    fileLabel.textContent = "Choisir une vidéo";
    loadVideos();
    
  } catch (err) {
    alert("Erreur: " + err.message);
  } finally {
    submitBtn.disabled = false;
    btnText.textContent = "Publier";
  }
});

// Charger les vidéos avec likes et commentaires
async function loadVideos(search = "") {
  const videosDiv = document.getElementById("videos");
  const emptyState = document.getElementById("empty-state");
  
  try {
    console.log("🔄 Rechargement des vidéos depuis la base de données...");
    
    // Requête simple pour récupérer UNIQUEMENT les vidéos existantes
    let query = supabaseClient
      .from("shorts")
      .select("*")
      .order("created_at", { ascending: false });

    if (search.trim()) {
      query = query.or(`title.ilike.%${search}%,description.ilike.%${search}%`);
    }

    const { data: videos, error } = await query;
    if (error) {
      console.error("❌ Erreur requête:", error);
      throw error;
    }

    console.log(`✅ ${videos?.length || 0} vidéo(s) trouvée(s) dans la base`);

    // Vider complètement la zone d'affichage
    videosDiv.innerHTML = "";
    emptyState.style.display = videos?.length === 0 ? "block" : "none";

    // Créer les cartes uniquement pour les vidéos existantes
    if (videos && videos.length > 0) {
      for (const video of videos) {
        await createVideoCard(video);
      }
    }

  } catch (err) {
    console.error("❌ Erreur chargement vidéos:", err);
    videosDiv.innerHTML = `
      <div style="text-align: center; color: #888; padding: 40px;">
        ❌ Erreur de chargement: ${err.message}
      </div>
    `;
  }
}

// Créer une carte vidéo avec interactions
async function createVideoCard(video) {
  const videosDiv = document.getElementById("videos");
  const card = document.createElement("div");
  card.className = "video-card";
  card.dataset.videoId = video.id;

  try {
    // Récupérer les compteurs séparément pour s'assurer de la fraîcheur des données
    const { data: likesData } = await supabaseClient
      .from('video_likes')
      .select('id')
      .eq('video_id', video.id);

    const { data: commentsData } = await supabaseClient
      .from('video_comments')
      .select('id')
      .eq('video_id', video.id);

    const likesCount = likesData?.length || 0;
    const commentsCount = commentsData?.length || 0;

    card.innerHTML = `
      <video src="${video.url}" controls preload="metadata" onerror="this.style.display='none'"></video>
      <div class="video-card-content">
        <h3>${escapeHtml(video.title)}</h3>
        <p>${escapeHtml(video.description)}</p>
        
        <div class="video-actions">
          <button class="action-btn like-btn" data-video-id="${video.id}">
            <span>❤️</span>
            <span class="like-count">${likesCount}</span>
          </button>
          <button class="action-btn comment-btn" data-video-id="${video.id}">
            <span>💬</span>
            <span class="comment-count">${commentsCount}</span>
          </button>
        </div>
        
        <div class="comments-section" style="display: none;">
          <div class="comment-form">
            <textarea class="comment-input" placeholder="Ajouter un commentaire..." maxlength="200"></textarea>
            <button class="comment-submit">Publier</button>
          </div>
          <div class="comments-list" data-video-id="${video.id}"></div>
        </div>
      </div>
    `;

    // Événements
    setupVideoEvents(card, video.id);
    videosDiv.appendChild(card);

  } catch (err) {
    console.error(`❌ Erreur création carte vidéo ${video.id}:`, err);
  }
}

// Fonction pour échapper le HTML (sécurité)
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// Configuration des événements pour chaque vidéo
function setupVideoEvents(card, videoId) {
  const likeBtn = card.querySelector('.like-btn');
  const commentBtn = card.querySelector('.comment-btn');
  const commentsSection = card.querySelector('.comments-section');
  const commentForm = card.querySelector('.comment-form');
  const commentInput = card.querySelector('.comment-input');
  const commentSubmit = card.querySelector('.comment-submit');

  // Toggle like
  likeBtn.addEventListener('click', async () => {
    await toggleLike(videoId, likeBtn);
  });

  // Toggle commentaires
  commentBtn.addEventListener('click', () => {
    const isVisible = commentsSection.style.display !== 'none';
    commentsSection.style.display = isVisible ? 'none' : 'block';
    if (!isVisible) {
      loadComments(videoId);
    }
  });

  // Soumettre commentaire
  commentSubmit.addEventListener('click', async () => {
    await submitComment(videoId, commentInput, commentSubmit);
  });

  // Enter pour soumettre
  commentInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      commentSubmit.click();
    }
  });
}

// Gérer les likes
async function toggleLike(videoId, likeBtn) {
  try {
    const { data: existingLike } = await supabaseClient
      .from('video_likes')
      .select('id')
      .eq('video_id', videoId)
      .eq('user_ip', await getUserIP())
      .single();

    if (existingLike) {
      // Supprimer le like
      await supabaseClient
        .from('video_likes')
        .delete()
        .eq('id', existingLike.id);
      
      likeBtn.classList.remove('liked');
    } else {
      // Ajouter le like
      await supabaseClient
        .from('video_likes')
        .insert([{
          video_id: videoId,
          user_ip: await getUserIP()
        }]);
      
      likeBtn.classList.add('liked');
    }

    // Mettre à jour le compteur
    const { data: likesData } = await supabaseClient
      .from('video_likes')
      .select('id')
      .eq('video_id', videoId);

    likeBtn.querySelector('.like-count').textContent = likesData?.length || 0;

  } catch (err) {
    console.error('Erreur like:', err);
  }
}

// Soumettre un commentaire
async function submitComment(videoId, input, submitBtn) {
  const text = input.value.trim();
  if (!text) return;

  submitBtn.disabled = true;
  
  try {
    await supabaseClient
      .from('video_comments')
      .insert([{
        video_id: videoId,
        text: text,
        user_ip: await getUserIP()
      }]);

    input.value = '';
    loadComments(videoId);

    // Mettre à jour le compteur
    const commentBtn = document.querySelector(`[data-video-id="${videoId}"].comment-btn`);
    const { data: commentsData } = await supabaseClient
      .from('video_comments')
      .select('id')
      .eq('video_id', videoId);

    commentBtn.querySelector('.comment-count').textContent = commentsData?.length || 0;

  } catch (err) {
    console.error('Erreur commentaire:', err);
  } finally {
    submitBtn.disabled = false;
  }
}

// Charger les commentaires
async function loadComments(videoId) {
  try {
    const { data: comments } = await supabaseClient
      .from('video_comments')
      .select('*')
      .eq('video_id', videoId)
      .order('created_at', { ascending: false })
      .limit(10);

    const commentsList = document.querySelector(`[data-video-id="${videoId}"].comments-list`);
    commentsList.innerHTML = '';

    comments?.forEach(comment => {
      const commentDiv = document.createElement('div');
      commentDiv.className = 'comment';
      commentDiv.innerHTML = `
        <div class="comment-text">${comment.text}</div>
        <div class="comment-date">${new Date(comment.created_at).toLocaleDateString('fr-FR')}</div>
      `;
      commentsList.appendChild(commentDiv);
    });

  } catch (err) {
    console.error('Erreur chargement commentaires:', err);
  }
}

// Obtenir l'IP de l'utilisateur (simple identification)
async function getUserIP() {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    return data.ip;
  } catch {
    return 'anonymous_' + Math.random().toString(36).substr(2, 9);
  }
}

// Recherche
let searchTimeout;
document.getElementById("search").addEventListener("input", (e) => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    loadVideos(e.target.value);
  }, 300);
});

// Fonction pour forcer le rechargement
function forceReload() {
  console.log("🔄 Rechargement forcé...");
  loadVideos();
}

// Rechargement automatique toutes les 30 secondes pour rester synchronisé
setInterval(() => {
  console.log("🔄 Rechargement automatique...");
  loadVideos();
}, 30000);

// Initialisation
loadVideos();
  </script>
</body>
</html>
