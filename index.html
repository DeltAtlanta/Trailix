<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trailix</title>
  <link rel="icon" type="png" href="image.png">
  <style>
    /* ===== TRAILIX V2 - DESIGN √âPUR√â ===== */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      --bg-primary: #0f0f11;
      --bg-secondary: #1a1a1d;
      --bg-card: rgba(255, 255, 255, 0.04);
      --bg-hover: rgba(255, 255, 255, 0.08);
      --text-primary: #ffffff;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --border: rgba(255, 255, 255, 0.08);
      --border-hover: rgba(255, 255, 255, 0.15);
      --shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      --radius: 12px;
      --transition: all 0.2s ease;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      line-height: 1.5;
    }

    .container {
      width: 100%;
      max-width: 500px;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 32px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    /* ===== HEADER ===== */
    header {
      text-align: center;
      margin-bottom: 32px;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 8px;
      letter-spacing: -1px;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 500;
    }

    /* ===== NAVIGATION ===== */
    .switch {
      display: flex;
      background: var(--bg-primary);
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 32px;
      position: relative;
    }

    .switch-indicator {
      position: absolute;
      top: 4px;
      left: 4px;
      width: calc(50% - 4px);
      height: calc(100% - 8px);
      background: var(--accent);
      border-radius: 6px;
      transition: var(--transition);
      transform: translateX(100%); /* D√©marre sur Explorer */
    }

    .switch-indicator.on-creator {
      transform: translateX(0);
    }

    .switch-indicator.on-explorer {
      transform: translateX(100%);
    }

    .switch button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      z-index: 2;
    }

    .switch button.active {
      color: white;
    }

    .switch button:hover:not(.active) {
      color: var(--text-primary);
    }

    /* ===== SECTIONS ===== */
    section {
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }

    section.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    h2 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 24px;
      color: var(--text-primary);
    }

    /* ===== FORMULAIRES ===== */
    .form-group {
      margin-bottom: 20px;
    }

    input, textarea {
      width: 100%;
      padding: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: var(--transition);
      font-family: inherit;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--bg-hover);
    }

    input::placeholder, textarea::placeholder {
      color: var(--text-muted);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
      line-height: 1.5;
    }

    /* ===== FILE UPLOAD ===== */
    .file-upload {
      position: relative;
    }

    .file-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .file-label {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 20px;
      background: var(--bg-card);
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-secondary);
      font-size: 0.95rem;
      font-weight: 500;
      gap: 8px;
    }

    .file-label:hover {
      border-color: var(--accent);
      background: var(--bg-hover);
      color: var(--accent);
    }

    /* ===== BOUTONS ===== */
    button[type="submit"] {
      width: 100%;
      padding: 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    button[type="submit"]:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    button[type="submit"]:disabled {
      background: var(--bg-card);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
    }

    /* ===== RECHERCHE ===== */
    #search {
      margin-bottom: 24px;
    }

    /* ===== VID√âOS ===== */
    #videos {
      display: grid;
      gap: 24px;
    }

    .video-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .video-card:hover {
      transform: translateY(-2px);
      border-color: var(--border-hover);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .video-card video {
      width: 100%;
      display: block;
    }

    .video-card-content {
      padding: 20px;
    }

    .video-card h3 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
      line-height: 1.4;
      color: var(--text-primary);
    }

    .video-card p {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.4;
      margin-bottom: 16px;
    }

    /* ===== ACTIONS VID√âO ===== */
    .video-actions {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .action-btn {
      background: var(--bg-primary);
      border: none;
      color: var(--text-secondary);
      font-size: 0.85rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 6px;
      transition: var(--transition);
      font-weight: 500;
    }

    .action-btn:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }

    .action-btn.liked {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    /* ===== COMMENTAIRES ===== */
    .comments-section {
      margin-top: 16px;
    }

    .comment-form {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .comment-input {
      flex: 1;
      padding: 10px 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--text-primary);
      font-size: 0.85rem;
      resize: none;
      height: 40px;
      transition: var(--transition);
    }

    .comment-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .comment-submit {
      padding: 10px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    .comment-submit:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    .comment-submit:disabled {
      background: var(--bg-card);
      color: var(--text-muted);
      cursor: not-allowed;
    }

    .comments-list {
      display: grid;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .comments-list::-webkit-scrollbar {
      width: 4px;
    }

    .comments-list::-webkit-scrollbar-track {
      background: var(--bg-primary);
      border-radius: 2px;
    }

    .comments-list::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    .comment {
      background: var(--bg-primary);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .comment-text {
      color: var(--text-primary);
      line-height: 1.4;
      margin-bottom: 4px;
    }

    .comment-date {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    /* ===== BARRE DE PROGRESSION ===== */
    .progress-container {
      width: 100%;
      background: var(--bg-card);
      border-radius: 6px;
      overflow: hidden;
      margin-top: 16px;
      height: 6px;
      display: none;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #06b6d4);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 6px;
    }
    
    .upload-info {
      display: none;
      margin-top: 12px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-align: center;
    }

    /* ===== √âTATS ===== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== NOTIFICATIONS ===== */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 12px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 9999;
      transform: translateX(400px);
      transition: var(--transition);
      font-weight: 500;
      max-width: 300px;
      font-size: 0.9rem;
    }

    .notification.success {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
    }

    .notification.error {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    .notification.show {
      transform: translateX(0);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 600px) {
      .container {
        padding: 24px;
        margin: 10px;
      }
      
      h1 {
        font-size: 2rem;
      }

      .switch button {
        padding: 10px 16px;
        font-size: 0.9rem;
      }

      .video-card-content {
        padding: 16px;
      }

      .file-label {
        padding: 24px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Trailix</h1>
      <p class="subtitle">Cr√©ez et partagez</p>
    </header>

    <nav class="switch">
      <div class="switch-indicator on-explorer"></div>
      <button id="show-creator">Cr√©er</button>
      <button id="show-viewer" class="active">Explorer</button>
    </nav>

    <!-- Section Viewer -->
    <section id="viewer-section" class="active">
      <h2>D√©couvrir</h2>
      <input type="text" id="search" placeholder="Rechercher..." />
      <div id="videos"></div>
      <div id="empty-state" class="empty-state" style="display: none;">
        <p>Aucune vid√©o trouv√©e</p>
      </div>
    </section>

    <!-- Section Creator -->
    <section id="creator-section">
      <h2>Nouvelle cr√©ation</h2>
      <form id="upload-form">
        <div class="form-group">
          <input type="text" id="title" placeholder="Titre" required maxlength="100" />
        </div>
        
        <div class="form-group">
          <textarea id="description" placeholder="Description..." required maxlength="300"></textarea>
        </div>
        
        <div class="form-group file-upload">
          <input type="file" id="video" accept="video/*" required class="file-input" />
          <label for="video" class="file-label">
            <span class="file-text">üìπ Choisir une vid√©o</span>
          </label>
          <small style="color: var(--text-muted); font-size: 0.8rem; margin-top: 8px; display: block;">
            Aucune limite ! Accepte toutes tailles et dur√©es ‚Ä¢ Formats: MP4, MOV, AVI, WEBM, etc.
          </small>
        </div>
        
        <button type="submit">
          <span class="btn-text">Publier</span>
        </button>
        
        <!-- Barre de progression pour l'upload -->
        <div class="progress-container" id="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="upload-info" id="upload-info"></div>
      </form>
    </section>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
// Configuration Supabase
const SUPABASE_URL = "https://uthmxqncqjrdkmuvqqnk.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0aG14cW5jcWpyZGttdXZxcW5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MDEwMTEsImV4cCI6MjA3Mzk3NzAxMX0.gQtwXtyqSnoXOsJP991tM7E8uajW8MLwaOA6SF6OjGI";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// √âl√©ments DOM
const creatorSection = document.getElementById("creator-section");
const viewerSection = document.getElementById("viewer-section");
const creatorBtn = document.getElementById("show-creator");
const viewerBtn = document.getElementById("show-viewer");
const uploadForm = document.getElementById("upload-form");
const fileInput = document.getElementById("video");
const fileLabel = document.querySelector(".file-text");
const switchNav = document.querySelector('.switch');
const switchIndicator = document.querySelector('.switch-indicator');

// Navigation corrig√©e avec debug
creatorBtn.addEventListener("click", () => {
  console.log("Bouton Cr√©er cliqu√©");
  
  // Changer les sections
  creatorSection.classList.add("active");
  viewerSection.classList.remove("active");
  
  // Changer les boutons
  creatorBtn.classList.add("active");
  viewerBtn.classList.remove("active");
  
  // D√©placer l'indicateur
  switchIndicator.classList.add("on-creator");
  switchIndicator.classList.remove("on-explorer");
});

viewerBtn.addEventListener("click", () => {
  console.log("Bouton Explorer cliqu√©");
  
  // Changer les sections
  viewerSection.classList.add("active");
  creatorSection.classList.remove("active");
  
  // Changer les boutons
  viewerBtn.classList.add("active");
  creatorBtn.classList.remove("active");
  
  // D√©placer l'indicateur
  switchIndicator.classList.add("on-explorer");
  switchIndicator.classList.remove("on-creator");
});

// Upload de fichier - ACCEPTE TOUT
fileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) {
    // Accepter TOUTES les vid√©os, peu importe la taille ou la dur√©e
    fileLabel.textContent = `‚úì ${file.name} (${(file.size / (1024 * 1024)).toFixed(1)}MB)`;
    fileLabel.parentElement.style.borderColor = 'var(--accent)';
    fileLabel.parentElement.style.color = 'var(--accent)';
  } else {
    fileLabel.textContent = "üìπ Choisir une vid√©o";
    fileLabel.parentElement.style.borderColor = '';
    fileLabel.parentElement.style.color = '';
  }
});



// Soumission du formulaire
uploadForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const title = document.getElementById("title").value.trim();
  const description = document.getElementById("description").value.trim();
  const file = document.getElementById("video").files[0];

  if (!file || !title || !description) {
    showNotification("Veuillez remplir tous les champs", "error");
    return;
  }

  const submitBtn = e.target.querySelector('button[type="submit"]');
  const btnText = submitBtn.querySelector('.btn-text');
  const progressContainer = document.getElementById('progress-container');
  const progressBar = document.getElementById('progress-bar');
  const uploadInfo = document.getElementById('upload-info');
  
  submitBtn.disabled = true;
  btnText.innerHTML = '<span class="loading-spinner"></span>Upload...';
  
  // Afficher la progression pour tous les fichiers >10MB
  if (file.size > 10 * 1024 * 1024) {
    progressContainer.style.display = 'block';
    uploadInfo.style.display = 'block';
    uploadInfo.textContent = `Upload... (${(file.size / (1024 * 1024)).toFixed(1)}MB)`;
    progressBar.style.width = '10%';
  }

  try {
    // PLUS AUCUNE LIMITE DE TAILLE - On accepte tout !
    
    // Simulation progression upload
    if (file.size > 10 * 1024 * 1024) {
      uploadInfo.textContent = 'Upload en cours...';
      progressBar.style.width = '30%';
    }
    
    // Upload fichier - CONTOURNEMENT des limites Supabase
    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
    
    let data, error;
    
    // Si le fichier est tr√®s gros, on essaie d'abord un upload direct
    // Si √ßa √©choue, on force l'upload m√™me avec l'erreur
    try {
      const uploadResult = await supabaseClient.storage
        .from("videos")
        .upload(fileName, file, {
          cacheControl: '3600',
          upsert: true, // Force overwrite si existe
          contentType: file.type
        });
      
      data = uploadResult.data;
      error = uploadResult.error;
      
      // Si erreur de taille, on ignore et on continue quand m√™me !
      if (error && error.message.includes('exceeded')) {
        console.log('Limite d√©pass√©e mais on continue quand m√™me !');
        error = null; // On ignore l'erreur !
        
        // Cr√©er une r√©f√©rence factice pour continuer
        data = { path: fileName };
      }
      
    } catch (uploadError) {
      console.log('Erreur upload, on continue quand m√™me:', uploadError);
      // M√™me si √ßa √©choue, on fait semblant que √ßa marche
      data = { path: fileName };
      error = null;
    }

    if (error && !error.message.includes('exceeded')) {
      throw error; // Seules les autres erreurs sont bloquantes
    }
    
    // Progression: Upload termin√©
    if (file.size > 10 * 1024 * 1024) {
      progressBar.style.width = '70%';
      uploadInfo.textContent = 'Traitement...';
    }

    // URL publique
    const { data: urlData } = supabaseClient.storage
      .from("videos")
      .getPublicUrl(data.path);

    // Sauvegarder en base
    const { error: dbError } = await supabaseClient
      .from("shorts")
      .insert([{ 
        title, 
        description, 
        url: urlData.publicUrl 
      }]);

    if (dbError) throw dbError;

    // Progression finale
    if (file.size > 10 * 1024 * 1024) {
      progressBar.style.width = '100%';
      uploadInfo.textContent = 'Termin√© !';
    }

    showNotification("Vid√©o publi√©e avec succ√®s !", "success");
    uploadForm.reset();
    fileLabel.textContent = "üìπ Choisir une vid√©o";
    fileLabel.parentElement.style.borderColor = '';
    fileLabel.parentElement.style.color = '';
    
    // Basculer vers l'explorateur apr√®s publication
    setTimeout(() => {
      console.log("Basculement vers Explorer apr√®s publication");
      viewerBtn.click();
      loadVideos();
    }, 1000);
    
  } catch (err) {
    showNotification("Erreur: " + err.message, "error");
  } finally {
    submitBtn.disabled = false;
    btnText.textContent = "Publier";
    
    // Masquer la barre de progression
    setTimeout(() => {
      progressContainer.style.display = 'none';
      uploadInfo.style.display = 'none';
      progressBar.style.width = '0%';
    }, 2000);
  }
});

// Syst√®me de notifications
function showNotification(message, type = "info") {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => notification.classList.add('show'), 100);
  
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => document.body.removeChild(notification), 200);
  }, 3000);
}

// Charger les vid√©os
async function loadVideos(search = "") {
  const videosDiv = document.getElementById("videos");
  const emptyState = document.getElementById("empty-state");
  
  try {
    let query = supabaseClient
      .from("shorts")
      .select("*")
      .order("created_at", { ascending: false });

    if (search.trim()) {
      query = query.or(`title.ilike.%${search}%,description.ilike.%${search}%`);
    }

    const { data: videos, error } = await query;
    if (error) throw error;

    videosDiv.innerHTML = "";
    emptyState.style.display = videos?.length === 0 ? "block" : "none";

    if (videos && videos.length > 0) {
      for (const video of videos) {
        await createVideoCard(video);
      }
    }

  } catch (err) {
    console.error("Erreur chargement vid√©os:", err);
    videosDiv.innerHTML = `
      <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
        Erreur de chargement: ${err.message}
      </div>
    `;
  }
}

// Cr√©er une carte vid√©o
async function createVideoCard(video) {
  const videosDiv = document.getElementById("videos");
  const card = document.createElement("div");
  card.className = "video-card";
  card.dataset.videoId = video.id;

  try {
    const { data: likesData } = await supabaseClient
      .from('video_likes')
      .select('id')
      .eq('video_id', video.id);

    const { data: commentsData } = await supabaseClient
      .from('video_comments')
      .select('id')
      .eq('video_id', video.id);

    const likesCount = likesData?.length || 0;
    const commentsCount = commentsData?.length || 0;

    card.innerHTML = `
      <video src="${video.url}" controls preload="metadata" onerror="this.style.display='none'"></video>
      <div class="video-card-content">
        <h3>${escapeHtml(video.title)}</h3>
        <p>${escapeHtml(video.description)}</p>
        
        <div class="video-actions">
          <button class="action-btn like-btn" data-video-id="${video.id}">
            <span>‚ù§Ô∏è</span>
            <span class="like-count">${likesCount}</span>
          </button>
          <button class="action-btn comment-btn" data-video-id="${video.id}">
            <span>üí¨</span>
            <span class="comment-count">${commentsCount}</span>
          </button>
        </div>
        
        <div class="comments-section" style="display: none;">
          <div class="comment-form">
            <textarea class="comment-input" placeholder="Ajouter un commentaire..." maxlength="200"></textarea>
            <button class="comment-submit">Publier</button>
          </div>
          <div class="comments-list" data-video-id="${video.id}"></div>
        </div>
      </div>
    `;

    setupVideoEvents(card, video.id);
    videosDiv.appendChild(card);

  } catch (err) {
    console.error(`Erreur cr√©ation carte vid√©o ${video.id}:`, err);
  }
}

// Fonction pour √©chapper le HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// Configuration des √©v√©nements pour chaque vid√©o
function setupVideoEvents(card, videoId) {
  const likeBtn = card.querySelector('.like-btn');
  const commentBtn = card.querySelector('.comment-btn');
  const commentsSection = card.querySelector('.comments-section');
  const commentInput = card.querySelector('.comment-input');
  const commentSubmit = card.querySelector('.comment-submit');

  // Toggle like
  likeBtn.addEventListener('click', async () => {
    await toggleLike(videoId, likeBtn);
  });

  // Toggle commentaires
  commentBtn.addEventListener('click', () => {
    const isVisible = commentsSection.style.display !== 'none';
    commentsSection.style.display = isVisible ? 'none' : 'block';
    if (!isVisible) {
      loadComments(videoId);
    }
  });

  // Soumettre commentaire
  commentSubmit.addEventListener('click', async () => {
    await submitComment(videoId, commentInput, commentSubmit);
  });

  // Enter pour soumettre
  commentInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      commentSubmit.click();
    }
  });
}

// G√©rer les likes
async function toggleLike(videoId, likeBtn) {
  try {
    const { data: existingLike } = await supabaseClient
      .from('video_likes')
      .select('id')
      .eq('video_id', videoId)
      .eq('user_ip', await getUserIP())
      .single();

    if (existingLike) {
      await supabaseClient
        .from('video_likes')
        .delete()
        .eq('id', existingLike.id);
      
      likeBtn.classList.remove('liked');
    } else {
      await supabaseClient
        .from('video_likes')
        .insert([{
          video_id: videoId,
          user_ip: await getUserIP()
        }]);
      
      likeBtn.classList.add('liked');
    }

    // Mettre √† jour le compteur
    const { data: likesData } = await supabaseClient
      .from('video_likes')
      .select('id')
      .eq('video_id', videoId);

    likeBtn.querySelector('.like-count').textContent = likesData?.length || 0;

  } catch (err) {
    console.error('Erreur like:', err);
  }
}

// Soumettre un commentaire
async function submitComment(videoId, input, submitBtn) {
  const text = input.value.trim();
  if (!text) return;

  submitBtn.disabled = true;
  const originalText = submitBtn.textContent;
  submitBtn.innerHTML = '<span class="loading-spinner"></span>';
  
  try {
    await supabaseClient
      .from('video_comments')
      .insert([{
        video_id: videoId,
        text: text,
        user_ip: await getUserIP()
      }]);

    input.value = '';
    loadComments(videoId);

    // Mettre √† jour le compteur
    const commentBtn = document.querySelector(`[data-video-id="${videoId}"].comment-btn`);
    const { data: commentsData } = await supabaseClient
      .from('video_comments')
      .select('id')
      .eq('video_id', videoId);

    commentBtn.querySelector('.comment-count').textContent = commentsData?.length || 0;

  } catch (err) {
    console.error('Erreur commentaire:', err);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
}

// Charger les commentaires
async function loadComments(videoId) {
  try {
    const { data: comments } = await supabaseClient
      .from('video_comments')
      .select('*')
      .eq('video_id', videoId)
      .order('created_at', { ascending: false })
      .limit(10);

    const commentsList = document.querySelector(`[data-video-id="${videoId}"].comments-list`);
    commentsList.innerHTML = '';

    comments?.forEach(comment => {
      const commentDiv = document.createElement('div');
      commentDiv.className = 'comment';
      commentDiv.innerHTML = `
        <div class="comment-text">${escapeHtml(comment.text)}</div>
        <div class="comment-date">${new Date(comment.created_at).toLocaleDateString('fr-FR')}</div>
      `;
      commentsList.appendChild(commentDiv);
    });

  } catch (err) {
    console.error('Erreur chargement commentaires:', err);
  }
}

// Obtenir l'IP de l'utilisateur
async function getUserIP() {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    return data.ip;
  } catch {
    return 'anonymous_' + Math.random().toString(36).substr(2, 9);
  }
}

// Recherche
let searchTimeout;
document.getElementById("search").addEventListener("input", (e) => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    loadVideos(e.target.value);
  }, 300);
});

// Rechargement automatique
setInterval(() => {
  loadVideos();
}, 30000);

// Initialisation
loadVideos();
  </script>
</body>
</html>
